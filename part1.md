# 简介和设置REPL

作为一名Web开发人员，我每天都在工作中使用关系数据库，但它们对我来说是一个黑匣子。我有一些问题：

- 数据以什么格式保存？（在内存和磁盘上）
- 它何时从内存移动到磁盘？
- 为什么每个表只能有一个主键？
- 回滚事务如何工作？
- 索引的格式是什么样的？
- 什么进行全表扫描？如何进行全表扫描？
- 预处理语句以什么格式保存？

为了弄清楚事情，我从头开始编写一个数据库。它是以sqlite为模型的，因为它被设计得很小，比MySQL或PostgreSQL的功能更少，所以我有更好的希望理解它。整个数据库存储在一个文件中！

## sqlite sqlite

sqlite网站上有很多关于sqlite内部的[文档](https://www.sqlite.org/arch.html)，另外还有一份SQLite数据库系统：设计和实现的[文档](https://play.google.com/store/books/details?id=9Z6IQQnX1JEC&pli=1)(该文档可能无法访问)。

sqlite的架构大致如下：

![](./img/arch1.gif)

查询通过组件链来检索或修改数据。前端包括：

- tokenizer 分词器
- parser 解析 器
- code generator 代码生成器

前端的输入是 SQL 查询。输出是SQLite虚拟机字节码（本质上是一个可以在数据库上运行的编译程序）。

后端包括：

- virtual machine 虚拟机
- B-tree B树
- pager 呼叫器
- os interface 界面

虚拟机将前端生成的字节码作为指令。然后，它可以对一个或多个表或索引执行操作，每个表或索引都存储在称为 B 树的数据结构中。VM 本质上是关于字节码指令类型的大开关语句。

每个 B 树由许多节点组成。每个节点的长度为一页。B树可以从磁盘检索页面，也可以通过向寻呼机发出命令将其保存回磁盘。